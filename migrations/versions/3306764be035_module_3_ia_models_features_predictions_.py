"""module 3 IA (models/features/predictions/logs/monitoring)

Revision ID: 3306764be035
Revises: c3d019f7b973
Create Date: 2025-09-01 20:09:09.471833

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '3306764be035'
down_revision: Union[str, Sequence[str], None] = 'c3d019f7b973'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('feature_store_metadata',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('nom_feature', sa.String(length=100), nullable=False),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('type_donnee', sa.String(length=50), nullable=True),
    sa.Column('source', sa.String(length=100), nullable=True),
    sa.Column('formule_calcul', sa.String(), nullable=True),
    sa.Column('importance_moyenne', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('statut', sa.String(length=20), server_default=sa.text("'actif'"), nullable=True),
    sa.Column('version', sa.String(length=20), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('nom_feature')
    )
    op.create_table('modeles_ia',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('nom', sa.String(length=100), nullable=False),
    sa.Column('version', sa.String(length=20), nullable=False),
    sa.Column('sport_id', sa.Integer(), nullable=False),
    sa.Column('type_prediction', sa.Enum('match_result', 'score_exact', 'over_under', 'both_teams_score', name='type_prediction_enum'), nullable=True),
    sa.Column('algorithme', sa.String(length=50), nullable=True),
    sa.Column('accuracy', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('precision_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('recall_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('f1_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('date_entrainement', sa.TIMESTAMP(), nullable=False),
    sa.Column('date_deploiement', sa.TIMESTAMP(), nullable=True),
    sa.Column('statut', sa.Enum('entrainement', 'validation', 'production', 'archive', name='statut_modele_enum'), server_default=sa.text("'entrainement'"), nullable=False),
    sa.Column('hyperparametres', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('features_utilisees', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('chemin_modele', sa.String(length=255), nullable=True),
    sa.Column('taille_mb', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('temps_entrainement_minutes', sa.Integer(), nullable=True),
    sa.Column('dataset_version', sa.String(length=20), nullable=True),
    sa.Column('created_by', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['utilisateurs.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['sport_id'], ['sports.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('model_monitoring',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('modele_id', sa.Integer(), nullable=False),
    sa.Column('date_evaluation', sa.Date(), nullable=False),
    sa.Column('nb_predictions', sa.Integer(), nullable=True),
    sa.Column('accuracy_reelle', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('drift_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('alertes', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('recommendations', sa.String(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=True),
    sa.ForeignKeyConstraint(['modele_id'], ['modeles_ia.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_monitoring_modele_date', 'model_monitoring', ['modele_id', 'date_evaluation'], unique=False)
    op.create_table('features_engineering',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('match_id', sa.Integer(), nullable=False),
    sa.Column('modele_id', sa.Integer(), nullable=False),
    sa.Column('forme_dom_5', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('forme_dom_10', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('moyenne_buts_marques_dom', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('moyenne_buts_encaisses_dom', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('clean_sheets_dom_5', sa.Integer(), nullable=True),
    sa.Column('forme_ext_5', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('forme_ext_10', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('moyenne_buts_marques_ext', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('moyenne_buts_encaisses_ext', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('clean_sheets_ext_5', sa.Integer(), nullable=True),
    sa.Column('h2h_victoires_dom', sa.Integer(), nullable=True),
    sa.Column('h2h_nuls', sa.Integer(), nullable=True),
    sa.Column('h2h_victoires_ext', sa.Integer(), nullable=True),
    sa.Column('h2h_moyenne_buts', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('jours_repos_dom', sa.Integer(), nullable=True),
    sa.Column('jours_repos_ext', sa.Integer(), nullable=True),
    sa.Column('nb_blesses_dom', sa.Integer(), nullable=True),
    sa.Column('nb_blesses_ext', sa.Integer(), nullable=True),
    sa.Column('importance_match_dom', sa.Integer(), nullable=True),
    sa.Column('importance_match_ext', sa.Integer(), nullable=True),
    sa.Column('elo_rating_dom', sa.Numeric(precision=8, scale=2), nullable=True),
    sa.Column('elo_rating_ext', sa.Numeric(precision=8, scale=2), nullable=True),
    sa.Column('xg_rolling_dom', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('xg_rolling_ext', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('features_custom', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('version_pipeline', sa.String(length=20), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=True),
    sa.ForeignKeyConstraint(['match_id'], ['matchs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['modele_id'], ['modeles_ia.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_features_match_modele', 'features_engineering', ['match_id', 'modele_id'], unique=False)
    op.create_table('predictions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('match_id', sa.Integer(), nullable=False),
    sa.Column('modele_id', sa.Integer(), nullable=False),
    sa.Column('type_prediction', sa.Enum('match_result', 'score_exact', 'over_under', 'both_teams_score', name='type_prediction_enum'), nullable=True),
    sa.Column('proba_victoire_dom', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('proba_nul', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('proba_victoire_ext', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('prediction_finale', sa.String(length=1), nullable=True),
    sa.Column('confidence', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('score_predit_dom', sa.Integer(), nullable=True),
    sa.Column('score_predit_ext', sa.Integer(), nullable=True),
    sa.Column('total_buts_predit', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('proba_over_2_5', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('proba_under_2_5', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('proba_btts_oui', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('proba_btts_non', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('features_importance', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('shap_values', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('date_prediction', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=True),
    sa.Column('batch_id', sa.String(length=50), nullable=True),
    sa.Column('temps_calcul_ms', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['match_id'], ['matchs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['modele_id'], ['modeles_ia.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_predictions_date', 'predictions', ['date_prediction'], unique=False)
    op.create_index('ix_predictions_match_modele_type', 'predictions', ['match_id', 'modele_id', 'type_prediction'], unique=False)
    op.create_table('logs_predictions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('prediction_id', sa.Integer(), nullable=False),
    sa.Column('match_id', sa.Integer(), nullable=False),
    sa.Column('modele_id', sa.Integer(), nullable=False),
    sa.Column('input_features', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('output_raw', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('temps_inference_ms', sa.Integer(), nullable=True),
    sa.Column('version_api', sa.String(length=20), nullable=True),
    sa.Column('erreur', sa.String(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=True),
    sa.ForeignKeyConstraint(['match_id'], ['matchs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['modele_id'], ['modeles_ia.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['prediction_id'], ['predictions.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_logs_predictions_created', 'logs_predictions', ['created_at'], unique=False)
    op.create_index('ix_logs_predictions_modele_created', 'logs_predictions', ['modele_id', 'created_at'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('ix_logs_predictions_modele_created', table_name='logs_predictions')
    op.drop_index('ix_logs_predictions_created', table_name='logs_predictions')
    op.drop_table('logs_predictions')
    op.drop_index('ix_predictions_match_modele_type', table_name='predictions')
    op.drop_index('ix_predictions_date', table_name='predictions')
    op.drop_table('predictions')
    op.drop_index('ix_features_match_modele', table_name='features_engineering')
    op.drop_table('features_engineering')
    op.drop_index('ix_monitoring_modele_date', table_name='model_monitoring')
    op.drop_table('model_monitoring')
    op.drop_table('modeles_ia')
    op.drop_table('feature_store_metadata')
    # ### end Alembic commands ###
